3:I[5613,[],""]
5:I[1778,[],""]
6:I[2175,["70","static/chunks/app/(articles)/layout-00d245b5a8171f02.js"],""]
4:["slug","go-sync-once-implemention","d"]
7:{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"}
8:{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"}
9:{"display":"inline-block"}
a:{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0}
0:["dgBRJkvLWLnV9qApEvfJa",[[["",{"children":["(articles)",{"children":["posts",{"children":[["slug","go-sync-once-implemention","d"],{"children":["__PAGE__?{\"slug\":\"go-sync-once-implemention\"}",{}]}]}]},"$undefined","$undefined",true]}],["",{"children":["(articles)",{"children":["posts",{"children":[["slug","go-sync-once-implemention","d"],{"children":["__PAGE__",{},["$L1","$L2",null]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(articles)","children","posts","children","$4","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5343b87885033c09.css","precedence":"next","crossOrigin":"anonymous"}]]}]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(articles)","children","posts","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}]]},[null,["$","$L6",null,{"children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","(articles)","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":null}],"params":{}}],null]]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":"$7","children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":"$8","children":"404"}],["$","div",null,{"style":"$9","children":["$","h2",null,{"style":"$a","children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/006888e039cb19be.css","precedence":"next","crossOrigin":"anonymous"}]]}]],[null,"$Lb"]]]]
2:["$","main",null,{"className":"markdown-body !bg-eerie-black-1 !text-white-2 box-border min-w-[200px] max-w-[980px] !my-0 !mx-auto p-[45px] pt-0 max-md:p-[15px] max-md:pt-0","children":["$","article",null,{"children":[["$","h1","h1-0",{"children":"sync.Once"}],"\n",["$","pre","pre-0",{"children":["$","div",null,{"style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none","padding":"1em","margin":"0.5em 0","overflow":"auto","borderRadius":"0.3em"},"children":["$","code",null,{"className":"language-go","style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none"},"children":[false,[["$","span","code-segement0",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["type"]}],["$","span","code-segement1",{"className":"$undefined","style":{},"children":[" Once "]}],["$","span","code-segement2",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["struct"]}],["$","span","code-segement3",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement4",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement5",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement6",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement7",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// done indicates whether the action has been performed."]}],["$","span","code-segement8",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement9",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement10",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// It is first in the struct because it is used in the hot path."]}],["$","span","code-segement11",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement12",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement13",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// The hot path is inlined at every call site."]}],["$","span","code-segement14",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement15",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement16",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// Placing done first allows more compact instructions on some architectures (amd64/386),"]}],["$","span","code-segement17",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement18",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement19",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// and fewer instructions (to calculate offset) on other architectures."]}],["$","span","code-segement20",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement21",{"className":"$undefined","style":{},"children":["\tdone "]}],["$","span","code-segement22",{"className":"token","style":{"color":"hsl(95, 38%, 62%)"},"children":["uint32"]}],["$","span","code-segement23",{"className":"$undefined","style":{},"children":["\n"]}],"\tm    Mutex\n",["$","span","code-segement25",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement26",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}]]]}]}]}],"\n",["$","p","p-0",{"children":[["$","code",null,{"className":"$undefined","children":"Once"}],"的结构比较简单，内部只有",["$","code",null,{"className":"$undefined","children":"done"}],"和",["$","code",null,{"className":"$undefined","children":"Mutex"}],"两个变量，",["$","code",null,{"className":"$undefined","children":"done"}],"用来表示调用是否完成，初始值为0，如果成功执行过一次",["$","code",null,{"className":"$undefined","children":"Do"}],"时，",["$","code",null,{"className":"$undefined","children":"done"}],"值变为1。"]}],"\n",["$","p","p-1",{"children":["这段注释很有意思，\"It is first in the struct because it is used in the hot path.\" 大概意思就是",["$","code",null,{"className":"$undefined","children":"done"}],"这个变量位于struct的第一个值是因为",["$","code",null,{"className":"$undefined","children":"done"}],"被使用“热路径”(hot path)里，我的理解就是在",["$","code",null,{"className":"$undefined","children":"Once"}],"这个结构中，",["$","code",null,{"className":"$undefined","children":"done"}],"变量使用得更频繁。\"Placing done first allows more compact instructions on some architectures (amd64/386),and fewer instructions (to calculate offset) on other architectures.\" 意思是把",["$","code",null,{"className":"$undefined","children":"done"}],"放在第一个可以使得在某些架构上（如amd64/386）指令更加紧凑，以及减少在其他架构上计算偏移量的指令数。"]}],"\n",["$","blockquote","blockquote-0",{"children":["\n",["$","p","p-0",{"children":"不得不感叹这些大佬写的代码，真细啊~"}],"\n"]}],"\n",["$","p","p-2",{"children":[["$","code",null,{"className":"$undefined","children":"sync.Once"}],"只有一个公共方法",["$","code",null,{"className":"$undefined","children":"Do"}]," ，一个",["$","code",null,{"className":"$undefined","children":"Once"}],"实例可以保证，",["$","code",null,{"className":"$undefined","children":"Do"}],"方法入参中的函数",["$","code",null,{"className":"$undefined","children":"f"}],"只被调用一次，多次使用",["$","code",null,{"className":"$undefined","children":"Do"}],"方法执行",["$","code",null,{"className":"$undefined","children":"f"}],"函数，只有第一次调用会被执行。常用于延迟初始化等。"]}],"\n",["$","pre","pre-1",{"children":["$","div",null,{"style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none","padding":"1em","margin":"0.5em 0","overflow":"auto","borderRadius":"0.3em"},"children":["$","code",null,{"className":"language-go","style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none"},"children":[false,[["$","span","code-segement0",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["func"]}],["$","span","code-segement1",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement2",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement3",{"className":"$undefined","style":{},"children":["o "]}],["$","span","code-segement4",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["*"]}],["$","span","code-segement5",{"className":"$undefined","style":{},"children":["Once"]}],["$","span","code-segement6",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement7",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement8",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["Do"]}],["$","span","code-segement9",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement10",{"className":"$undefined","style":{},"children":["f "]}],["$","span","code-segement11",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["func"]}],["$","span","code-segement12",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement13",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement14",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement15",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement16",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement17",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement18",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement19",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// Note: Here is an incorrect implementation of Do:"]}],["$","span","code-segement20",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement21",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement22",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["//"]}],["$","span","code-segement23",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement24",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement25",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["//\tif atomic.CompareAndSwapUint32(&o.done, 0, 1) {"]}],["$","span","code-segement26",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement27",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement28",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["//\t\tf()"]}],["$","span","code-segement29",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement30",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement31",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["//\t}"]}],["$","span","code-segement32",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement33",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement34",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["//"]}],["$","span","code-segement35",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement36",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement37",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// Do guarantees that when it returns, f has finished."]}],["$","span","code-segement38",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement39",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement40",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// This implementation would not implement that guarantee:"]}],["$","span","code-segement41",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement42",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement43",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// given two simultaneous calls, the winner of the cas would"]}],["$","span","code-segement44",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement45",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement46",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// call f, and the second would return immediately, without"]}],["$","span","code-segement47",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement48",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement49",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// waiting for the first's call to f to complete."]}],["$","span","code-segement50",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement51",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement52",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// This is why the slow path falls back to a mutex, and why"]}],["$","span","code-segement53",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement54",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement55",{"className":"token","style":{"color":"hsl(220, 10%, 40%)","fontStyle":"italic"},"children":["// the atomic.StoreUint32 must be delayed until after f returns."]}],["$","span","code-segement56",{"className":"$undefined","style":{},"children":["\n"]}],"\n",["$","span","code-segement58",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement59",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["if"]}],["$","span","code-segement60",{"className":"$undefined","style":{},"children":[" atomic"]}],["$","span","code-segement61",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement62",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["LoadUint32"]}],["$","span","code-segement63",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement64",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["&"]}],["$","span","code-segement65",{"className":"$undefined","style":{},"children":["o"]}],["$","span","code-segement66",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement67",{"className":"$undefined","style":{},"children":["done"]}],["$","span","code-segement68",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement69",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement70",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["=="]}],["$","span","code-segement71",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement72",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["0"]}],["$","span","code-segement73",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement74",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement75",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement76",{"className":"$undefined","style":{},"children":["\t\to"]}],["$","span","code-segement77",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement78",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["doSlow"]}],["$","span","code-segement79",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement80",{"className":"$undefined","style":{},"children":["f"]}],["$","span","code-segement81",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement82",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement83",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement84",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}],["$","span","code-segement85",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement86",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement87",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}],["$","span","code-segement88",{"className":"$undefined","style":{},"children":["\n"]}],"\n",["$","span","code-segement90",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement91",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["func"]}],["$","span","code-segement92",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement93",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement94",{"className":"$undefined","style":{},"children":["o "]}],["$","span","code-segement95",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["*"]}],["$","span","code-segement96",{"className":"$undefined","style":{},"children":["Once"]}],["$","span","code-segement97",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement98",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement99",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["doSlow"]}],["$","span","code-segement100",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement101",{"className":"$undefined","style":{},"children":["f "]}],["$","span","code-segement102",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["func"]}],["$","span","code-segement103",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement104",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement105",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement106",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement107",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement108",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement109",{"className":"$undefined","style":{},"children":["\to"]}],["$","span","code-segement110",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement111",{"className":"$undefined","style":{},"children":["m"]}],["$","span","code-segement112",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement113",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["Lock"]}],["$","span","code-segement114",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement115",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement116",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement117",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement118",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["defer"]}],["$","span","code-segement119",{"className":"$undefined","style":{},"children":[" o"]}],["$","span","code-segement120",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement121",{"className":"$undefined","style":{},"children":["m"]}],["$","span","code-segement122",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement123",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["Unlock"]}],["$","span","code-segement124",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement125",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement126",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement127",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement128",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["if"]}],["$","span","code-segement129",{"className":"$undefined","style":{},"children":[" o"]}],["$","span","code-segement130",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement131",{"className":"$undefined","style":{},"children":["done "]}],["$","span","code-segement132",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["=="]}],["$","span","code-segement133",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement134",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["0"]}],["$","span","code-segement135",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement136",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement137",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement138",{"className":"$undefined","style":{},"children":["\t\t"]}],["$","span","code-segement139",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["defer"]}],["$","span","code-segement140",{"className":"$undefined","style":{},"children":[" atomic"]}],["$","span","code-segement141",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement142",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["StoreUint32"]}],["$","span","code-segement143",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement144",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["&"]}],["$","span","code-segement145",{"className":"$undefined","style":{},"children":["o"]}],["$","span","code-segement146",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement147",{"className":"$undefined","style":{},"children":["done"]}],["$","span","code-segement148",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[","]}],["$","span","code-segement149",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement150",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["1"]}],["$","span","code-segement151",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement152",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement153",{"className":"$undefined","style":{},"children":["\t\t"]}],["$","span","code-segement154",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["f"]}],["$","span","code-segement155",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement156",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement157",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement158",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement159",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}],["$","span","code-segement160",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement161",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement162",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}]]]}]}]}],"\n",["$","p","p-3",{"children":[["$","code",null,{"className":"$undefined","children":"Do"}],"方法使用",["$","code",null,{"className":"$undefined","children":"done"}],"来标识当前",["$","code",null,{"className":"$undefined","children":"Once"}],"实例是否被执行过，仅当首次执行的时候才会调用",["$","code",null,{"className":"$undefined","children":"doSlow"}],"，",["$","code",null,{"className":"$undefined","children":"doSlow"}],"中的逻辑比较容易理解，使用",["$","code",null,{"className":"$undefined","children":"sync.Mutex"}],"进行加锁，执行",["$","code",null,{"className":"$undefined","children":"f"}],"，",["$","code",null,{"className":"$undefined","children":"done"}],"置为1。逻辑看着很简单，但实际上这几行代码还是比较精妙的，让我们来思考几个问题："]}],"\n",["$","ul","ul-0",{"children":["\n",["$","li","li-0",{"children":["为什么需要在",["$","code",null,{"className":"$undefined","children":"Do"}],"中判断一遍",["$","code",null,{"className":"$undefined","children":"done"}],"的值，",["$","code",null,{"className":"$undefined","children":"doSlow"}],"里再判断一遍，而不是只需要",["$","code",null,{"className":"$undefined","children":"doSlow"}],"里面的这段逻辑？"]}],"\n",["$","li","li-1",{"children":["为什么需要先执行",["$","code",null,{"className":"$undefined","children":"f"}],"，再更新",["$","code",null,{"className":"$undefined","children":"done"}],"的值，而不是反过来？"]}],"\n"]}],"\n",["$","p","p-4",{"children":["针对第一个问题，还是比较容易想到的，如果没有外层的",["$","code",null,{"className":"$undefined","children":"atomic.LoadUint32(&o.done) == 0"}],"，直接使用",["$","code",null,{"className":"$undefined","children":"doSlow"}],"中的逻辑，会导致每一个",["$","code",null,{"className":"$undefined","children":"Do"}],"的调用都会竞争互斥锁",["$","code",null,{"className":"$undefined","children":"Mutex"}],"，这样会严重影响性能，外层加一个对",["$","code",null,{"className":"$undefined","children":"done"}],"的判断，可以避免大量的锁竞争，当",["$","code",null,{"className":"$undefined","children":"Do(f)"}],"已经被执行过后，后续的",["$","code",null,{"className":"$undefined","children":"Do"}],"调用都可以迅速的返回。"]}],"\n",["$","pre","pre-2",{"children":["$","div",null,{"style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none","padding":"1em","margin":"0.5em 0","overflow":"auto","borderRadius":"0.3em"},"children":["$","code",null,{"className":"language-go","style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none"},"children":[false,[["$","span","code-segement0",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["if"]}],["$","span","code-segement1",{"className":"$undefined","style":{},"children":[" atomic"]}],["$","span","code-segement2",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement3",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["LoadUint32"]}],["$","span","code-segement4",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement5",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["&"]}],["$","span","code-segement6",{"className":"$undefined","style":{},"children":["o"]}],["$","span","code-segement7",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement8",{"className":"$undefined","style":{},"children":["done"]}],["$","span","code-segement9",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement10",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement11",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["=="]}],["$","span","code-segement12",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement13",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["0"]}],["$","span","code-segement14",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement15",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement16",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement17",{"className":"$undefined","style":{},"children":["    o"]}],["$","span","code-segement18",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement19",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["doSlow"]}],["$","span","code-segement20",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement21",{"className":"$undefined","style":{},"children":["f"]}],["$","span","code-segement22",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement23",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement24",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement25",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}]]]}]}]}],"\n",["$","p","p-5",{"children":"第二个问题就需要稍微细致地去思考下，执行顺序反过来会有什么影响了，源码注释中解释了这个问题。"}],"\n",["$","blockquote","blockquote-1",{"children":["\n",["$","p","p-0",{"children":"Note: Here is an incorrect implementation of Do:"}],"\n",["$","pre","pre-0",{"children":["$","div",null,{"style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none","padding":"1em","margin":"0.5em 0","overflow":"auto","borderRadius":"0.3em"},"children":["$","code",null,{"className":"language-go","style":{"background":"hsl(220, 13%, 18%)","color":"hsl(220, 14%, 71%)","textShadow":"0 1px rgba(0, 0, 0, 0.3)","fontFamily":"\"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace","direction":"ltr","textAlign":"left","whiteSpace":"pre","wordSpacing":"normal","wordBreak":"normal","lineHeight":"1.5","MozTabSize":"2","OTabSize":"2","tabSize":"2","WebkitHyphens":"none","MozHyphens":"none","msHyphens":"none","hyphens":"none"},"children":[false,[["$","span","code-segement0",{"className":"token","style":{"color":"hsl(286, 60%, 67%)"},"children":["if"]}],["$","span","code-segement1",{"className":"$undefined","style":{},"children":[" atomic"]}],["$","span","code-segement2",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement3",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["CompareAndSwapUint32"]}],["$","span","code-segement4",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement5",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["&"]}],["$","span","code-segement6",{"className":"$undefined","style":{},"children":["o"]}],["$","span","code-segement7",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["."]}],["$","span","code-segement8",{"className":"$undefined","style":{},"children":["done"]}],["$","span","code-segement9",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[","]}],["$","span","code-segement10",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement11",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["0"]}],["$","span","code-segement12",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[","]}],["$","span","code-segement13",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement14",{"className":"token","style":{"color":"hsl(29, 54%, 61%)"},"children":["1"]}],["$","span","code-segement15",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement16",{"className":"$undefined","style":{},"children":[" "]}],["$","span","code-segement17",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["{"]}],["$","span","code-segement18",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement19",{"className":"$undefined","style":{},"children":["\t"]}],["$","span","code-segement20",{"className":"token","style":{"color":"hsl(207, 82%, 66%)"},"children":["f"]}],["$","span","code-segement21",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["("]}],["$","span","code-segement22",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":[")"]}],["$","span","code-segement23",{"className":"$undefined","style":{},"children":["\n"]}],["$","span","code-segement24",{"className":"$undefined","style":{},"children":[""]}],["$","span","code-segement25",{"className":"token","style":{"color":"hsl(220, 14%, 71%)"},"children":["}"]}]]]}]}]}],"\n"]}],"\n",["$","p","p-6",{"children":["注释中给出了一种",["$","code",null,{"className":"$undefined","children":"Do"}],"的错误实现，直接使用CAS来更新",["$","code",null,{"className":"$undefined","children":"done"}],"的值，这样可以保证",["$","code",null,{"className":"$undefined","children":"done"}],"只被成功更新一次，",["$","code",null,{"className":"$undefined","children":"f"}],"也就自然只会被执行一次了，这样看起来好像没问题？是的，这确实能保证",["$","code",null,{"className":"$undefined","children":"f"}],"只能被执行一次，但问题在于当",["$","code",null,{"className":"$undefined","children":"Do"}],"执行完毕返回时，",["$","code",null,{"className":"$undefined","children":"f"}],"还没有完成，试想一个这样的场景："]}],"\n",["$","ul","ul-1",{"children":["\n",["$","li","li-0",{"children":["\n",["$","p","p-0",{"children":["A调用",["$","code",null,{"className":"$undefined","children":"Do"}],"，同时B调用了",["$","code",null,{"className":"$undefined","children":"Do"}]]}],"\n"]}],"\n",["$","li","li-1",{"children":["\n",["$","p","p-0",{"children":["A赢得了CAS的执行，这时候",["$","code",null,{"className":"$undefined","children":"done"}],"被置为1，",["$","code",null,{"className":"$undefined","children":"f"}],"正在执行中"]}],"\n"]}],"\n",["$","li","li-2",{"children":["\n",["$","p","p-0",{"children":["B中的",["$","code",null,{"className":"$undefined","children":"Do"}],"竞争CAS失败，没有等待A执行",["$","code",null,{"className":"$undefined","children":"f"}],"完毕就",["$","strong","strong-0",{"children":"直接返回了"}]]}],"\n"]}],"\n"]}],"\n",["$","p","p-7",{"children":["如果在延时初始化的场景，B就会任务初始化完成了，实际上初始化函数",["$","code",null,{"className":"$undefined","children":"f"}],"还在执行中，这样可能会导致空指针等问题发生。"]}],"\n",["$","blockquote","blockquote-2",{"children":["\n",["$","p","p-0",{"children":"Do guarantees that when it returns, f has finished.This implementation would not implement that guarantee."}],"\n"]}],"\n",["$","p","p-8",{"children":"意思为Do确保当它返回时，f函数已经被执行完毕了，而上面那种错误的实现保证不了这一点"}],"\n",["$","p","p-9",{"children":["同时注释中也解释了我们前面提到的第二个问题：为什么需要先执行",["$","code",null,{"className":"$undefined","children":"f"}],"，再更新",["$","code",null,{"className":"$undefined","children":"done"}],"的值，而不是反过来？"]}],"\n",["$","blockquote","blockquote-3",{"children":["\n",["$","p","p-0",{"children":"This is why the slow path falls back to a mutex, and why the atomic.StoreUint32 must be delayed until after f returns."}],"\n",["$","p","p-1",{"children":["这就是为什么",["$","code",null,{"className":"$undefined","children":"slowDo"}],"需要使用互斥锁(等待执行",["$","code",null,{"className":"$undefined","children":"f"}],"函数的",["$","code",null,{"className":"$undefined","children":"Do"}],"返回)，以及为什么",["$","code",null,{"className":"$undefined","children":"atomic.StoreUint32"}],"必须在",["$","code",null,{"className":"$undefined","children":"f"}],"执行完成后执行"]}],"\n"]}]]}]}]
b:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"sync.Once源码解析，大佬们充满细节的代码"}],["$","link","3",{"rel":"manifest","href":"/site.webmanifest"}],["$","meta","4",{"property":"og:title","content":"sync.Once源码解析，大佬们充满细节的代码"}],["$","meta","5",{"property":"og:image","content":"http://localhost:3000/images/gopher-1.png"}],["$","meta","6",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","7",{"name":"twitter:title","content":"sync.Once源码解析，大佬们充满细节的代码"}],["$","meta","8",{"name":"twitter:image","content":"http://localhost:3000/images/gopher-1.png"}],["$","link","9",{"rel":"shortcut icon","href":"/apple-touch-icon.png"}],["$","link","10",{"rel":"icon","href":"/favicon.ico?v=4"}],["$","link","11",{"rel":"apple-touch-icon","href":"/apple-touch-icon.png?v=4"}]]
1:null
