<!DOCTYPE html><html lang="zh"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="/_next/static/css/006888e039cb19be.css" crossorigin="anonymous" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/5343b87885033c09.css" crossorigin="anonymous" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-34f6785fee3c4072.js" crossorigin=""/><script src="/_next/static/chunks/fd9d1056-51d8d8d03ff1ca8b.js" async="" crossorigin=""></script><script src="/_next/static/chunks/69-64de97e1ac338c06.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-deef63d82231dbe2.js" async="" crossorigin=""></script><script src="/_next/static/chunks/app/(articles)/layout-00d245b5a8171f02.js" async="" crossorigin=""></script><title>一个bug引发的思考：屎山是怎么形成的</title><link rel="manifest" href="/site.webmanifest"/><meta property="og:title" content="一个bug引发的思考：屎山是怎么形成的"/><meta property="og:image" content="http://localhost:3000/images/developer-1.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="一个bug引发的思考：屎山是怎么形成的"/><meta name="twitter:image" content="http://localhost:3000/images/developer-1.jpg"/><link rel="shortcut icon" href="/apple-touch-icon.png"/><link rel="icon" href="/favicon.ico?v=4"/><link rel="apple-touch-icon" href="/apple-touch-icon.png?v=4"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="anonymous" noModule=""></script></head><body class="!bg-eerie-black-1"><nav class="p-4 bg-eerie-black-2"><div class="flex items-center w-28 text-orange-yellow-crayola hover:text-light-gray-70 focus:text-light-gray-70 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" height="24" width="24" class="inline"><path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 1 1 1.06 1.06L9.31 12l6.97 6.97a.75.75 0 1 1-1.06 1.06l-7.5-7.5Z" clip-rule="evenodd"></path></svg><span class="ml-1]">Back</span></div></nav><main class="markdown-body !bg-eerie-black-1 !text-white-2 box-border min-w-[200px] max-w-[980px] !my-0 !mx-auto p-[45px] pt-0 max-md:p-[15px] max-md:pt-0"><article><h1>MySQL和ES数据不一致</h1>
<p>项目中使用了<code>ES</code>作为搜索引擎来避免慢查询，<code>MySQL</code>到<code>ES</code>的同步逻辑为更新DB后发送<code>Kafka</code>消息，另一个服务来消费消息并写入<code>ES</code>，最近发现偶尔会出现<code>MySQL</code>和<code>ES</code>的数据不一致的情况。</p>
<p>最终定位到了一个更新数据的方法<code>updateA</code>，此方法被注解为<code>Transactional</code>，前半部分为更新DB和缓存等，最后一步是异步地去发<code>kafka</code>更新<code>ES</code>。后续迭代中，<code>updateB</code>引用了这个方法，并且由于<code>updateB</code>也有数据需要更新，所以在<code>updateB</code>上也加了<code>Transactional</code>的注解。</p>
<h2>问题复现</h2>
<p>简单还原下出现问题的代码：</p>
<pre><div style="background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto;border-radius:0.3em"><code class="language-java" style="background:hsl(220, 13%, 18%);color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token annotation" style="color:hsl(220, 14%, 71%)">@Transactional</span><span>
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">public</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">void</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">updateA</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 更新MySQL</span><span>
</span><span>    </span><span class="token" style="color:hsl(207, 82%, 66%)">updateDB</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 更新缓存</span><span>
</span><span>    </span><span class="token" style="color:hsl(207, 82%, 66%)">updateCache</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 异步发消息更新ES</span><span>
</span><span>    </span><span class="token" style="color:hsl(207, 82%, 66%)">asyncSendMessage</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">;</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span>
<span></span><span class="token annotation" style="color:hsl(220, 14%, 71%)">@Transactional</span><span>
</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">public</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">void</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">updateB</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 更新MySQL</span><span>
</span><span>    </span><span class="token" style="color:hsl(207, 82%, 66%)">updateDB</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 调用已有方法更新A</span><span>
</span><span>    </span><span class="token" style="color:hsl(207, 82%, 66%)">updateA</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>xxx</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">;</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic">// 执行其他操作</span><span>
</span><span>    </span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>
</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span></code></div></pre>
<p>这里有一个非常重要的点是<code>asyncSendMessage</code>方法里<strong>依赖了DB中的最新数据</strong>，其实如果真实的业务代码就长这样的话，还是比较容易看出问题的：<code>asyncSendMessage</code>是异步的，会和<code>updateB</code>里余下的操作并行，并且<code>updateB</code>是加了<code>Transactional</code>注解的，<code>updateA</code>加入了<code>updateB</code>的事务，此时<code>updateA</code>中DB的更新还未提交，所以异步发消息的时候只能读到DB中旧的数据，从而导致更新到<code>ES</code>中的是旧数据。</p>
<p>为什么这个问题是偶现的呢？那是因为异步发消息这个方法里并不是简单的直接发消息，还有各种前置的数据组装流程，如果<code>updateB</code>余下的代码执行得够快，就能抢在<code>asyncSendMessage</code>中的<code>DB</code>查询之前提交事务，这样<code>asyncSendMessage</code>中拿到的就是新数据了。</p>
<h2>排查过程中的坑</h2>
<p>从上面来看，这个问题好像非常基础，且容易发现。但实际排查这个问题的时候还是花了不少时间，这是因为<code>updateA</code>中的逻辑非常复杂，光是方法本身就几百行代码，并且嵌套得也很深，异步发消息更新<code>ES</code>这个动作隐藏在了最底层一个看着是公共方法里（当时也许是想减少同步<code>MySQL</code>到<code>ES</code>的重复代码？）。所以在后续的迭代引入<code>updateB</code>时，<code>updateB</code>自身也发了更新<code>ES</code>的消息，这导致更新<code>ES</code>的消息发送了两次，而异步发送的那次有一定的概率拿到的是旧数据，所以才会出现<code>ES</code>中最终保存的是旧数据。（这里还有一个比较坑的地方，异步发消息的逻辑没有把trace id包进去，导致拿着trace id看日志的时候只查到发送了一次消息，且内容为最新的，非常具有迷惑性！！！）。</p>
<h2>总结</h2>
<p>问题本身其实没什么好总结的，就是错误使用了异步&amp;事务。但这次踩坑引发了我的思考：<strong>为什么会写出这样的代码？</strong></p>
<p>发出这个疑问并不是说要批斗写出这样代码的人，而是想从软件工程的角度上思考下，为什么会发生这样的情况。</p>
<ul>
<li>
<p><strong>对已有逻辑的复用</strong>：复用前人留下的代码时，没有仔细地去检查代码逻辑，而是比较粗暴的沿用了。不过我认为，虽然这是引起这个bug最直接的原因，但并不是最根本的原因，因为这个<code>updateA</code>方法实在太复杂了，主打一个all in one，A以及A关联的业务数据更新&amp;缓存更新&amp;消息发送都在这里面，想要理清楚其内部错综复杂的逻辑得花非常多的时间和精力。</p>
</li>
<li>
<p><strong>复杂代码的恶循环</strong>：<code>updateA</code>方法逻辑写得过于复杂，也许当时写这段逻辑的人认为这个方法就是给部分接口专用的，觉得其他地方不用复用这个方法。但业务是会不断迭代的，这段代码大概率是熟悉相关业务逻辑的唯一渠道，当后续接手这个项目的人需要有这段逻辑相关的业务开发时，将会面临两个选择：</p>
<ol>
<li>
<p>复用这一段代码：构造出方法<code>updateA</code>庞大的入参，并对内部部分不适配的逻辑打补丁来兼容新的业务逻辑</p>
</li>
<li>
<p>重构这一段代码：将<code>updateA</code>从头到尾梳理一遍，并实现一套新的逻辑来提供扩展性。</p>
</li>
</ol>
<p>我相信，在实际的业务开发中选择第二个选项的可能性几乎为0。因为成本和风险都太高了，<code>updateA</code>以及其内部嵌套的代码加起来小几千行，并且错综复杂。理解和重构的成本极高，并且理解成本高会带来另一个问题，一些角落的细节逻辑非常容易被遗漏。选择重构引入了巨大的成本和风险，这两点都是业务迭代中不被允许的，很少人会选择这样一条极其曲折且伴随了风险，但又难以体现业务价值的路。</p>
<p>所以我们只能想方设法来复用<code>updateA</code>，首先我们需要拿现有数据构造出符合<code>updateA</code>的入参（实际上代码里已经有人这样干了，新增了一个<code>genUpdateAParams</code>的一个方法用于构造符合<code>updateA</code>的参数，光是这个方法都好几百行🤦🏻），然后再往<code>updateA</code>以及其嵌套的逻辑中打<code>if ... else</code>补丁来适配新的业务规则。好了，代码已经踏上了奔往💩山的不归路，下一个改到相关逻辑的时候得去理解<code>updateA</code>和<code>genUpdateAParams</code>这两座💩山了，于是开始在<code>updateA</code>和<code>genUpdateAParams</code>中同时打补丁，甚至又多加一座。。。</p>
</li>
</ul>
<p>我们反过来想一想，如果<code>updateA</code>方法真的像我们示例中的那样简洁明了，后面的迭代是不是更不容易写出难以理解和维护的代码呢？</p>
<p>我想结果是显然的，在实现<code>updateB</code>的时候，我们可以很轻易地复用<code>updateA</code>中的<code>updateDB</code>和<code>updateCache</code>，然后发送自己所需要的消息以及后续的逻辑，而不是被迫复用整个<code>updateA</code>，那么也不会有<code>genUpdateAParams</code>的出现了。</p>
<p><strong>结语：</strong> 写出简洁、清晰的代码是非常重要的，少做一点妥协，尽量写好每一段代码，哪怕这个方法后面真的永远不会被复用或者改动。毕竟代码更多时候是用来读的，简洁清晰的代码可以让其他人更容易理解其背后的业务逻辑（btw，这个其他人也可能是几个月后的自己👀）。</p></article></main><script src="/_next/static/chunks/webpack-34f6785fee3c4072.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"0:\"$L1\"\n"])</script><script>self.__next_f.push([1,"2:HL[\"/_next/static/css/006888e039cb19be.css\",\"style\",{\"crossOrigin\":\"\"}]\n3:HL[\"/_next/static/css/5343b87885033c09.css\",\"style\",{\"crossOrigin\":\"\"}]\n"])</script><script>self.__next_f.push([1,"4:I[7690,[],\"\"]\n7:I[5613,[],\"\"]\n9:I[1778,[],\"\"]\na:I[2175,[\"70\",\"static/chunks/app/(articles)/layout-00d245b5a8171f02.js\"],\"\"]\n10:I[8955,[],\"\"]\n8:[\"slug\",\"thoughts-provoked-by-a-bug\",\"d\"]\nb:{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"}\nc:{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"}\nd:{\"display\":\"inline-block\"}\ne:{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0}\n11:[]\n"])</script><script>self.__next_f.push([1,"1:[null,[\"$\",\"$L4\",null,{\"buildId\":\"4sFLY0YSptLMsIZg55uJf\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/thoughts-provoked-by-a-bug/\",\"initialTree\":[\"\",{\"children\":[\"(articles)\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"thoughts-provoked-by-a-bug\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"thoughts-provoked-by-a-bug\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true]}],\"initialSeedData\":[\"\",{\"children\":[\"(articles)\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"thoughts-provoked-by-a-bug\",\"d\"],{\"children\":[\"__PAGE__\",{},[\"$L5\",\"$L6\",null]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(articles)\",\"children\",\"posts\",\"children\",\"$8\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/5343b87885033c09.css\",\"precedence\":\"next\",\"crossOrigin\":\"anonymous\"}]]}]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(articles)\",\"children\",\"posts\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]]},[null,[\"$\",\"$La\",null,{\"children\":[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"(articles)\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}],\"params\":{}}],null]]},[\"$\",\"$L7\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"loadingScripts\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L9\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":\"$b\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":\"$c\",\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":\"$d\",\"children\":[\"$\",\"h2\",null,{\"style\":\"$e\",\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/006888e039cb19be.css\",\"precedence\":\"next\",\"crossOrigin\":\"anonymous\"}]]}]],\"initialHead\":[false,\"$Lf\"],\"globalErrorComponent\":\"$10\",\"missingSlots\":\"$W11\"}]]\n"])</script><script>self.__next_f.push([1,"6:[\"$\",\"main\",null,{\"className\":\"markdown-body !bg-eerie-black-1 !text-white-2 box-border min-w-[200px] max-w-[980px] !my-0 !mx-auto p-[45px] pt-0 max-md:p-[15px] max-md:pt-0\",\"children\":[\"$\",\"article\",null,{\"children\":[[\"$\",\"h1\",\"h1-0\",{\"children\":\"MySQL和ES数据不一致\"}],\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"项目中使用了\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"作为搜索引擎来避免慢查询，\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"MySQL\"}],\"到\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"的同步逻辑为更新DB后发送\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"Kafka\"}],\"消息，另一个服务来消费消息并写入\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"，最近发现偶尔会出现\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"MySQL\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"的数据不一致的情况。\"]}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":[\"最终定位到了一个更新数据的方法\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"，此方法被注解为\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"Transactional\"}],\"，前半部分为更新DB和缓存等，最后一步是异步地去发\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"kafka\"}],\"更新\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"。后续迭代中，\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"引用了这个方法，并且由于\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"也有数据需要更新，所以在\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"上也加了\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"Transactional\"}],\"的注解。\"]}],\"\\n\",[\"$\",\"h2\",\"h2-0\",{\"children\":\"问题复现\"}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":\"简单还原下出现问题的代码：\"}],\"\\n\",[\"$\",\"pre\",\"pre-0\",{\"children\":[\"$\",\"div\",null,{\"style\":{\"background\":\"hsl(220, 13%, 18%)\",\"color\":\"hsl(220, 14%, 71%)\",\"textShadow\":\"0 1px rgba(0, 0, 0, 0.3)\",\"fontFamily\":\"\\\"Fira Code\\\", \\\"Fira Mono\\\", Menlo, Consolas, \\\"DejaVu Sans Mono\\\", monospace\",\"direction\":\"ltr\",\"textAlign\":\"left\",\"whiteSpace\":\"pre\",\"wordSpacing\":\"normal\",\"wordBreak\":\"normal\",\"lineHeight\":\"1.5\",\"MozTabSize\":\"2\",\"OTabSize\":\"2\",\"tabSize\":\"2\",\"WebkitHyphens\":\"none\",\"MozHyphens\":\"none\",\"msHyphens\":\"none\",\"hyphens\":\"none\",\"padding\":\"1em\",\"margin\":\"0.5em 0\",\"overflow\":\"auto\",\"borderRadius\":\"0.3em\"},\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"style\":{\"background\":\"hsl(220, 13%, 18%)\",\"color\":\"hsl(220, 14%, 71%)\",\"textShadow\":\"0 1px rgba(0, 0, 0, 0.3)\",\"fontFamily\":\"\\\"Fira Code\\\", \\\"Fira Mono\\\", Menlo, Consolas, \\\"DejaVu Sans Mono\\\", monospace\",\"direction\":\"ltr\",\"textAlign\":\"left\",\"whiteSpace\":\"pre\",\"wordSpacing\":\"normal\",\"wordBreak\":\"normal\",\"lineHeight\":\"1.5\",\"MozTabSize\":\"2\",\"OTabSize\":\"2\",\"tabSize\":\"2\",\"WebkitHyphens\":\"none\",\"MozHyphens\":\"none\",\"msHyphens\":\"none\",\"hyphens\":\"none\"},\"children\":[false,[[\"$\",\"span\",\"code-segement0\",{\"className\":\"token annotation\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"@Transactional\"]}],[\"$\",\"span\",\"code-segement1\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement2\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement3\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(286, 60%, 67%)\"},\"children\":[\"public\"]}],[\"$\",\"span\",\"code-segement4\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement5\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(286, 60%, 67%)\"},\"children\":[\"void\"]}],[\"$\",\"span\",\"code-segement6\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement7\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateA\"]}],[\"$\",\"span\",\"code-segement8\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement9\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement10\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement11\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement12\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"{\"]}],[\"$\",\"span\",\"code-segement13\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement14\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement15\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 更新MySQL\"]}],[\"$\",\"span\",\"code-segement16\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement17\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement18\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateDB\"]}],[\"$\",\"span\",\"code-segement19\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement20\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement21\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement22\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\";\"]}],[\"$\",\"span\",\"code-segement23\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement24\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement25\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 更新缓存\"]}],[\"$\",\"span\",\"code-segement26\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement27\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement28\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateCache\"]}],[\"$\",\"span\",\"code-segement29\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement30\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement31\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement32\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\";\"]}],[\"$\",\"span\",\"code-segement33\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement34\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement35\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 异步发消息更新ES\"]}],[\"$\",\"span\",\"code-segement36\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement37\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement38\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"asyncSendMessage\"]}],[\"$\",\"span\",\"code-segement39\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement40\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement41\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement42\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\";\"]}],[\"$\",\"span\",\"code-segement43\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement44\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement45\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"}\"]}],[\"$\",\"span\",\"code-segement46\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],\"\\n\",[\"$\",\"span\",\"code-segement48\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement49\",{\"className\":\"token annotation\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"@Transactional\"]}],[\"$\",\"span\",\"code-segement50\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement51\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement52\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(286, 60%, 67%)\"},\"children\":[\"public\"]}],[\"$\",\"span\",\"code-segement53\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement54\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(286, 60%, 67%)\"},\"children\":[\"void\"]}],[\"$\",\"span\",\"code-segement55\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement56\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateB\"]}],[\"$\",\"span\",\"code-segement57\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement58\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement59\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\" \"]}],[\"$\",\"span\",\"code-segement60\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"{\"]}],[\"$\",\"span\",\"code-segement61\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement62\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement63\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 更新MySQL\"]}],[\"$\",\"span\",\"code-segement64\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement65\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement66\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateDB\"]}],[\"$\",\"span\",\"code-segement67\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement68\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement69\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement70\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\";\"]}],[\"$\",\"span\",\"code-segement71\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement72\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement73\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 调用已有方法更新A\"]}],[\"$\",\"span\",\"code-segement74\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement75\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement76\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(207, 82%, 66%)\"},\"children\":[\"updateA\"]}],[\"$\",\"span\",\"code-segement77\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"(\"]}],[\"$\",\"span\",\"code-segement78\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"xxx\"]}],[\"$\",\"span\",\"code-segement79\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\")\"]}],[\"$\",\"span\",\"code-segement80\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\";\"]}],[\"$\",\"span\",\"code-segement81\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement82\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement83\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 10%, 40%)\",\"fontStyle\":\"italic\"},\"children\":[\"// 执行其他操作\"]}],[\"$\",\"span\",\"code-segement84\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement85\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"    \"]}],[\"$\",\"span\",\"code-segement86\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\".\"]}],[\"$\",\"span\",\"code-segement87\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\".\"]}],[\"$\",\"span\",\"code-segement88\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\".\"]}],[\"$\",\"span\",\"code-segement89\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\\n\"]}],[\"$\",\"span\",\"code-segement90\",{\"className\":\"$undefined\",\"style\":{},\"children\":[\"\"]}],[\"$\",\"span\",\"code-segement91\",{\"className\":\"token\",\"style\":{\"color\":\"hsl(220, 14%, 71%)\"},\"children\":[\"}\"]}]]]}]}]}],\"\\n\",[\"$\",\"p\",\"p-3\",{\"children\":[\"这里有一个非常重要的点是\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"asyncSendMessage\"}],\"方法里\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"依赖了DB中的最新数据\"}],\"，其实如果真实的业务代码就长这样的话，还是比较容易看出问题的：\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"asyncSendMessage\"}],\"是异步的，会和\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"里余下的操作并行，并且\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"是加了\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"Transactional\"}],\"注解的，\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"加入了\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"的事务，此时\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"中DB的更新还未提交，所以异步发消息的时候只能读到DB中旧的数据，从而导致更新到\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"中的是旧数据。\"]}],\"\\n\",[\"$\",\"p\",\"p-4\",{\"children\":[\"为什么这个问题是偶现的呢？那是因为异步发消息这个方法里并不是简单的直接发消息，还有各种前置的数据组装流程，如果\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"余下的代码执行得够快，就能抢在\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"asyncSendMessage\"}],\"中的\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"DB\"}],\"查询之前提交事务，这样\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"asyncSendMessage\"}],\"中拿到的就是新数据了。\"]}],\"\\n\",[\"$\",\"h2\",\"h2-1\",{\"children\":\"排查过程中的坑\"}],\"\\n\",[\"$\",\"p\",\"p-5\",{\"children\":[\"从上面来看，这个问题好像非常基础，且容易发现。但实际排查这个问题的时候还是花了不少时间，这是因为\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"中的逻辑非常复杂，光是方法本身就几百行代码，并且嵌套得也很深，异步发消息更新\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"这个动作隐藏在了最底层一个看着是公共方法里（当时也许是想减少同步\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"MySQL\"}],\"到\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"的重复代码？）。所以在后续的迭代引入\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"时，\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"自身也发了更新\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"的消息，这导致更新\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"的消息发送了两次，而异步发送的那次有一定的概率拿到的是旧数据，所以才会出现\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"ES\"}],\"中最终保存的是旧数据。（这里还有一个比较坑的地方，异步发消息的逻辑没有把trace id包进去，导致拿着trace id看日志的时候只查到发送了一次消息，且内容为最新的，非常具有迷惑性！！！）。\"]}],\"\\n\",[\"$\",\"h2\",\"h2-2\",{\"children\":\"总结\"}],\"\\n\",[\"$\",\"p\",\"p-6\",{\"children\":[\"问题本身其实没什么好总结的，就是错误使用了异步\u0026事务。但这次踩坑引发了我的思考：\",[\"$\",\"strong\",\"strong-0\",{\"children\":\"为什么会写出这样的代码？\"}]]}],\"\\n\",[\"$\",\"p\",\"p-7\",{\"children\":\"发出这个疑问并不是说要批斗写出这样代码的人，而是想从软件工程的角度上思考下，为什么会发生这样的情况。\"}],\"\\n\",[\"$\",\"ul\",\"ul-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"对已有逻辑的复用\"}],\"：复用前人留下的代码时，没有仔细地去检查代码逻辑，而是比较粗暴的沿用了。不过我认为，虽然这是引起这个bug最直接的原因，但并不是最根本的原因，因为这个\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"方法实在太复杂了，主打一个all in one，A以及A关联的业务数据更新\u0026缓存更新\u0026消息发送都在这里面，想要理清楚其内部错综复杂的逻辑得花非常多的时间和精力。\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"复杂代码的恶循环\"}],\"：\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"方法逻辑写得过于复杂，也许当时写这段逻辑的人认为这个方法就是给部分接口专用的，觉得其他地方不用复用这个方法。但业务是会不断迭代的，这段代码大概率是熟悉相关业务逻辑的唯一渠道，当后续接手这个项目的人需要有这段逻辑相关的业务开发时，将会面临两个选择：\"]}],\"\\n\",[\"$\",\"ol\",\"ol-0\",{\"children\":[\"\\n\",[\"$\",\"li\",\"li-0\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"复用这一段代码：构造出方法\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"庞大的入参，并对内部部分不适配的逻辑打补丁来兼容新的业务逻辑\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",\"li-1\",{\"children\":[\"\\n\",[\"$\",\"p\",\"p-0\",{\"children\":[\"重构这一段代码：将\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"从头到尾梳理一遍，并实现一套新的逻辑来提供扩展性。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-1\",{\"children\":[\"我相信，在实际的业务开发中选择第二个选项的可能性几乎为0。因为成本和风险都太高了，\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"以及其内部嵌套的代码加起来小几千行，并且错综复杂。理解和重构的成本极高，并且理解成本高会带来另一个问题，一些角落的细节逻辑非常容易被遗漏。选择重构引入了巨大的成本和风险，这两点都是业务迭代中不被允许的，很少人会选择这样一条极其曲折且伴随了风险，但又难以体现业务价值的路。\"]}],\"\\n\",[\"$\",\"p\",\"p-2\",{\"children\":[\"所以我们只能想方设法来复用\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"，首先我们需要拿现有数据构造出符合\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"的入参（实际上代码里已经有人这样干了，新增了一个\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"genUpdateAParams\"}],\"的一个方法用于构造符合\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"的参数，光是这个方法都好几百行🤦🏻），然后再往\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"以及其嵌套的逻辑中打\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"if ... else\"}],\"补丁来适配新的业务规则。好了，代码已经踏上了奔往💩山的不归路，下一个改到相关逻辑的时候得去理解\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"genUpdateAParams\"}],\"这两座💩山了，于是开始在\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"genUpdateAParams\"}],\"中同时打补丁，甚至又多加一座。。。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",\"p-8\",{\"children\":[\"我们反过来想一想，如果\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"方法真的像我们示例中的那样简洁明了，后面的迭代是不是更不容易写出难以理解和维护的代码呢？\"]}],\"\\n\",[\"$\",\"p\",\"p-9\",{\"children\":[\"我想结果是显然的，在实现\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateB\"}],\"的时候，我们可以很轻易地复用\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"中的\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateDB\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateCache\"}],\"，然后发送自己所需要的消息以及后续的逻辑，而不是被迫复用整个\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"updateA\"}],\"，那么也不会有\",[\"$\",\"code\",null,{\"className\":\"$undefined\",\"children\":\"genUpdateAParams\"}],\"的出现了。\"]}],\"\\n\",[\"$\",\"p\",\"p-10\",{\"children\":[[\"$\",\"strong\",\"strong-0\",{\"children\":\"结语：\"}],\" 写出简洁、清晰的代码是非常重要的，少做一点妥协，尽量写好每一段代码，哪怕这个方法后面真的永远不会被复用或者改动。毕竟代码更多时候是用来读的，简洁清晰的代码可以让其他人更容易理解其背后的业务逻辑（btw，这个其他人也可能是几个月后的自己👀）。\"]}]]}]}]\n"])</script><script>self.__next_f.push([1,"f:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"一个bug引发的思考：屎山是怎么形成的\"}],[\"$\",\"link\",\"3\",{\"rel\":\"manifest\",\"href\":\"/site.webmanifest\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:title\",\"content\":\"一个bug引发的思考：屎山是怎么形成的\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:image\",\"content\":\"http://localhost:3000/images/developer-1.jpg\"}],[\"$\",\"meta\",\"6\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:title\",\"content\":\"一个bug引发的思考：屎山是怎么形成的\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:image\",\"content\":\"http://localhost:3000/images/developer-1.jpg\"}],[\"$\",\"link\",\"9\",{\"rel\":\"shortcut icon\",\"href\":\"/apple-touch-icon.png\"}],[\"$\",\"link\",\"10\",{\"rel\":\"icon\",\"href\":\"/favicon.ico?v=4\"}],[\"$\",\"link\",\"11\",{\"rel\":\"apple-touch-icon\",\"href\":\"/apple-touch-icon.png?v=4\"}]]\n5:null\n"])</script><script>self.__next_f.push([1,""])</script></body></html>